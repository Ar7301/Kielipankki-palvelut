---
# install dependencies

- name: create dir
  file:
    path: "{{ item }}"
    state: directory
  with_items:
   - "{{ compile_dir }}"
   - "{{ install_dir }}"

- name: get nasm
  # workaround missing SNI support in Taito's python 2.6
  command: wget "https://www.zytor.com/pub/nasm/releasebuilds/{{ nasm_version }}/nasm-{{ nasm_version }}.tar.bz2"
  args:
    chdir: "{{ compile_dir }}"
    creates: "nasm-{{ nasm_version }}.tar.bz2"

- name: unpack nasm
  unarchive:
    remote_src: yes
    src: "{{ compile_dir }}/nasm-{{ nasm_version }}.tar.bz2"
    dest: "{{ compile_dir }}"     

- name: compile nasm 
  command: "{{ item }}"
  args:
    chdir: "{{ compile_dir }}/nasm-{{ nasm_version }}" 
    creates: "{{ install_dir }}/bin/nasm"
  with_items:
    - ./configure --prefix={{ install_dir }}
    - make -j5
    - make install

- name: Fix permissions (if shared group is set)
  file:
    path={{ nasm_install_dir }}
    group={{ shared_group }}
    mode="g+rwX,o+rX"
    recurse=yes
  when: shared_group is defined